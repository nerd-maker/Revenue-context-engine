version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: revenue-context-db
    environment:
      POSTGRES_DB: revenue_context
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: revenue-context-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

  # Kafka (using Redpanda for simplicity)
  kafka:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: revenue-context-kafka
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://kafka:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://kafka:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr kafka:33145
      - --advertise-rpc-addr kafka:33145
      - --smp 1
      - --memory 1G
      - --mode dev-container
    ports:
      - "19092:19092"
      - "18081:18081"
      - "18082:18082"
    volumes:
      - kafka_data:/var/lib/redpanda/data
    healthcheck:
      test: [ "CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true' || exit 1" ]
      interval: 15s
      timeout: 3s
      retries: 5

  # Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: revenue-context-backend
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${DB_PASSWORD:-changeme}@postgres:5432/revenue_context
      REDIS_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      ENV: production
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      LLM_DAILY_LIMIT_PER_ACCOUNT: ${LLM_DAILY_LIMIT_PER_ACCOUNT:-10}
      HIGH_INTENT_THRESHOLD: ${HIGH_INTENT_THRESHOLD:-70}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # Context Engine Worker
  context-engine-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: revenue-context-worker
    command: python -m app.services.context_engine
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${DB_PASSWORD:-changeme}@postgres:5432/revenue_context
      REDIS_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      ENV: production
      WORKER_ID: context-engine-1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: unless-stopped

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: revenue-context-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  kafka_data:
